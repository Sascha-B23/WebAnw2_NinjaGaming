<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="Css/Css_Final.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="JQuery_JS/urlParameter.js"></script>
<script src="JQuery_JS/sessionHandling.js"></script>
<script src="JQuery_JS/Sortierung.js"></script>
<script src="JQuery_JS/Script.js"></script>
<script src="JQuery_JS/urlParameter.js"></script>
</head>
<body>
    <header></header>

    <div id="nav"></div>
    <h1 id="warenkorb_h1">Warenkorb</h1>
    <div id="test" class="warenkorb_main"><!--    <div class="warenkorb_spiel">
        <a href="kaufseite.html"><img class="warenkorb_spielanzeige" src="Bilder/The Elder Scrolls Online - Greymoor [Standard Edition].jpg" alt="Spiel"/></a>
        
        <div class="warenkorb_spielbeschreibung">
            <h4>The Elder Scrolls Online - Greymoor [Standard Edition]</h4>
            <h5>Plattform: PS4</h5>
            <h5>Erscheinungsjahr: 2020</h5>    
        </div>
        <div class="warenkorb_kaufart">
            <h4>Kaufpreis UVP</h4>  
        </div>

        <div class="warenkorb_preis">
            <h4>59,99€</h4>
        </div>
        
        <div class="warenkorb_rechterContainer">

            <button class="warenkorb_entfernen">
                entfernen
            </button>
            
        </div>
    </div>
    <div class="warenkorb_spiel">
        <a href="kaufseite.html"><img class="warenkorb_spielanzeige" src="Bilder/The Elder Scrolls Online - Greymoor [Standard Edition].jpg" alt="Spiel"/></a>
        
        <div class="warenkorb_spielbeschreibung">
            <h4>The Elder Scrolls Online - Greymoor [Standard Edition]</h4>
            <h5>Plattform: PS4</h5>
            <h5>Erscheinungsjahr: 2020</h5>    
        </div>
        <div class="warenkorb_kaufart">
            <h4>Geliehen für:</h4>  
            <select class="dropdown_warenkorb">
                <option>1 Tag</option>
                <option>2 Tage</option>
                <option>3 Tage</option>
                <option>4 Tage</option>
                <option selected>5 Tage</option>
                <option>7 Tage / 1 Woche</option>
                <option>14 Tage / 2 Wochen</option>
            </select> 
        </div>

        <div class="warenkorb_preis">
            <h4>25,00€</h4>
        </div>
        
        <div class="warenkorb_rechterContainer">

            <button class="warenkorb_entfernen">
                entfernen
            </button>
            
        </div>
        
    </div>
    <div class="gesamtpreis_warenkorb">
        <hr>
        <div class="gesamtpreis_warenkorb_links">
            <h4>Enth. MwSt.</h4>
            <h3>Gesamtsumme</h3>
        </div>
        <div class="gesamtpreis_warenkorb_rechts">
            <h4>xx,xx€</h4>
            <h3>xx,xx€</h3>
        </div>
    </div> --></div>
    <div class="zur_kasse">
    <a href="kasse.html"><button>Zur Kasse</button></a>
    </div>

    <footer></footer>


    <script>
        //Erstellung Header
        createHeader();
        // Erstellung des Navs
        createNav();
        // Erstellung des Footers
        createFooter();

        function showBasket() {
              // aktuelle warenkorbdaten in konsole anzeigen lassen
              console.log(basket);
              if (basket.length == 0) {
              // warenkorb_leer noch in css anlegen
                    $('DIV#test').append($('<h2>').addClass('warenkorb_leer').text('Der Warenkorb ist leer'));
              }
              else {
                  //hier dynamischen Code eintragen 
                  //angezeigt werden muss: Spielbild, Spielname, Plattform, Erscheinungsjahr, Gekauft/Leihdauer,
                  // Preis und entfernen Button
                  //ganz unten noch enth. MwSt. und Gesamtsumme  
                    for (var i=0; i < basket.length; i++) {
                        if (basket[i].leihdauer == 0) {
                            $('DIV.warenkorb_main').append(
                            $('<div>')
                                .addClass('warenkorb_spiel')
                                .append($('<a>').attr('href','kaufseite.html?spielId='+basket[i].spielId).append($('<img>').addClass('warenkorb_spielanzeige').attr('src', basket[i].spielbild)))
                                .append($('<div>').addClass('warenkorb_spielbeschreibung').append($('<h4>').text(basket[i].spielname)).append($('<h5>').text('Plattform: ' + basket[i].plattform)).append($('<h5>').text('Erscheinungsjahr: ' + basket[i].erscheinungsjahr)))
                                .append($('<div>').addClass('warenkorb_kaufart').append($('<h4>').text('Kaufpreis UVP')))
                                .append($('<div>').addClass('warenkorb_preis').append($('<h4>').text(toKomma(basket[i].bruttokaufpreis) + '€')))
                                .append($('<div>').addClass('warenkorb_rechterContainer').append($('<button>').addClass('warenkorb_entfernen').attr("onclick","removeElement('" + i + "')").text('entfernen'))))
                        }
                        else if (basket[i].leihdauer > 0) {
                            $('DIV.warenkorb_main').append(
                            $('<div>')
                                .addClass('warenkorb_spiel')
                                .append($('<a>').attr('href','kaufseite.html?spielId='+basket[i].spielId).append($('<img>').addClass('warenkorb_spielanzeige').attr('src', basket[i].spielbild)))
                                .append($('<div>').addClass('warenkorb_spielbeschreibung').append($('<h4>').text(basket[i].spielname)).append($('<h5>').text('Plattform: ' + basket[i].plattform)).append($('<h5>').text('Erscheinungsjahr: ' + basket[i].erscheinungsjahr)))
                                .append($('<div>').addClass('warenkorb_kaufart').append($('<h4>').text('Geliehen für: ' + basket[i].leihdauer + ' Tage')))
                                .append($('<div>').addClass('warenkorb_preis').append($('<h4>').text(toKomma((basket[i].bruttoleihpreis * basket[i].leihdauer).toFixed(2)) + '€')))
                                .append($('<div>').addClass('warenkorb_rechterContainer').append($('<button>').addClass('warenkorb_entfernen').attr("onclick","removeElement('" + i + "')").text('entfernen'))));
                        }
                        // GANZER WRENKORB LEEREN: removeSessionItem('basket')

                        
                    }
                    $('DIV.zur_kasse').append($('<button>').attr("onclick", "removeSessionItem('basket')").text("Kompletten Einkaufskorb leeren"));

              }

          }
  </script>
<script>
// WARENKORB WIRD NOCH GEÄNDERT (SO WIE IN DER PRAKTIKUMSSTUNDE GEZEIGT MIT SESSION ID USW)
        // initialisierung (globale variable)
    var basket = [];
        $(document).ready(function() {
            // schauen ob in der session bereits ein warenkorb existiert, falls ja diesen holen
            if (existsSessionItem('basket')){
                basket = getJSONSessionItem('basket');
                console.log("Warenkorb exist");
            }
             
            // produkt in warenkorb hinzufügen bzw. menge ändern
            if (existsUrlParameter('addToBasket')) {
                console.log("ausgelesen");
                // id aus parameter holen
                var productId = getUrlParameterValue('addToBasket');
                var leihdauer = 0;
                if (existsUrlParameter('leihdauer')){
                     var leihdauer = getUrlParameterValue('leihdauer');
                 }

                $.ajax({
                    url: 'http://localhost:8000/api/spiel/gib/' + productId,
                    method: 'GET',
                    dataType: 'json'
                })
                .done(function(httpResponse) {
                    var spiel = httpResponse.daten
                    var idx = -1;
                    var idx = -1;
                    for (i = 0; i < basket.length; i++) {
                        if (basket[i].spielId === spiel.id) {
                        idx = i;
                        alert("Artikel schon im Warenkorb! Sie können jedes Spiel" +
                        " nur einmal erweben! Entfernen Sie gegebenenfalls den Artikel und " +
                        "fügen sie ihn wieder hinzu, falls sie sich für eine andere Leihdauer " +
                        "entschieden haben.")
                        break;
                        }
                    }

                    if (idx === -1) {
                        var bestellposition = {
                            spielId :   spiel.id,
                            spielname : spiel.spielname,
                            spielbild : spiel.bilder[0].bildpfad,
                            plattform : spiel.spielplattform.name,
                            erscheinungsjahr : spiel.erscheinungsjahr,
                            leihdauer : leihdauer,
                            kaufpreis : spiel.nettokaufpreis,
                            leihpreis : spiel.nettoleihpreis,
                            mehrwertsteuer : spiel.mehrwertsteuer.steuersatz,
                            bruttokaufpreis : spiel.bruttokaufpreis,
                            bruttoleihpreis : spiel.bruttoleihpreis

                        };
                        basket.push(bestellposition);
                        console.log(basket.length);
                        setJSONSessionItem('basket', basket);
                        refreshPage();
                    }
                })

                .fail(function(jqXHR, statusText, error) {
                console.log(statusText);
                alert("Es ist ein Fehler aufgetreten");
                });
            }
        });        
        // $(document).ready(function() {
        //     $.ajax({
        //         url: "http://localhost:8000/api/bestellung/alle",
        //         method: "GET",
        //         dataType: "json"
        //     })
        //     .done(function(httpResponse) {
        //         var list = httpResponse.daten
                
        //         for (i = 0; i < 1; i++){
        //             var b = 0; //also in bestellung/alle die Position in der Liste (hier jetzt zum Beispiel die erste Bestellung) (später dann ändern)
        //             // was für i<...??
        //             for (i = 0; i < list[b].bestellpositionen.length; i++){
        //                 $('DIV.warenkorb_main').append(
        //                     $('<div>')
        //                         .addClass('warenkorb_spiel')
        //                         .append($('<a>').attr('href','kaufseite.html?spielId='+list[b].bestellpositionen[i].spielid).append($('<img>').addClass('warenkorb_spielanzeige').attr('src', list[b].bestellpositionen[i].spiel.bilder[0].bildpfad)))
        //                         .append($('<div>').addClass('warenkorb_spielbeschreibung').append($('<h4>').text(list[b].bestellpositionen[i].spiel.spielname)).append($('<h5>').text('Plattform: ' + list[b].bestellpositionen[i].spiel.spielplattform.name)).append($('<h5>').text('Erscheinungsjahr: ' + list[b].bestellpositionen[i].spiel.erscheinungsjahr)))
        //                         .append(function(){
        //                             if (list[b].bestellpositionen[i].gekauft == 0){ //0 heißt das Spiel wird geliehen
        //                                 return $('<div>').addClass('warenkorb_kaufart').append($('<h4>').text('Geliehen für: ' + list[b].bestellpositionen[i].leihzeit + ' Tage'))
        //                             }else if (list[b].bestellpositionen[i].gekauft == 1){ //1 heißt das Spiel wird gekauft
        //                                 return $('<div>').addClass('warenkorb_kaufart').append($('<h4>').text('Kaufpreis UVP'))
        //                             }
        //                         })
        //                         .append($('<div>').addClass('warenkorb_preis').append($('<h4>').text(list[b].bestellpositionen[i].bruttopreis + '€')))
        //                         .append($('<div>').addClass('warenkorb_rechterContainer').append($('<button>').addClass('warenkorb_entfernen').text('entfernen'))))

        //             }
        //             $('DIV.warenkorb_main').append(
        //                 $('<div>')
        //                     .addClass('gesamtpreis_warenkorb')
        //                     .append($('<hr>'))
        //                     .append($('<div>').addClass('gesamtpreis_warenkorb_links').append($('<h4>').text('Enth. MwSt.')).append($('<h3>').text('Gesamtsumme')))
        //                     .append($('<div>').addClass('gesamtpreis_warenkorb_rechts').append($('<h4>').text(list[b].total.mehrwertsteuer + '€').append($('<h3>').text(list[b].total.brutto + '€'))))
        //             );
                    
        //         }
        //     })
        //     .fail(function(jqXHR, statusText, error) {
        //         console.log(statusText);
        //         alert("Es ist ein Fehler aufgetreten");
        //     })
        // });
    </script>
<script>
    $(document).ready(function() {
        showBasket(); })
</script>
</body>
</html>